<!doctype html><html><head>
<meta charset="utf-8"/>
<title>Metals 12-Month Auto Builder (Fixed Keys)</title>
<style>
 body{font-family:-apple-system,system-ui;padding:20px;background:#fafafa}
 #card{max-width:960px;margin:auto;background:#fff;padding:16px;border-radius:8px;
       box-shadow:0 4px 14px rgba(0,0,0,.08);}
 canvas{width:100%!important;height:420px!important}
 small{color:#666}
</style>
</head><body>
<div id="card">
 <h3>Metals — Auto-Collected 12-Month Trend</h3>
 <small>Gold & Palladium ÷1000, Silver ÷10 — Free Tier Incremental Builder</small>
 <div id="status" style="margin-bottom:10px;color:#444"></div>
 <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async()=>{

  const KEY = "725119967737018ac36bec66d4a87c96";

  // CORRECT keys based on your actual Metals-API response
  const METALS = [
    {key:"Gold(USDXAU)",      div:1000, label:"Gold"},
    {key:"Silver(USDXAG)",    div:10,   label:"Silver"},
    {key:"Palladium(USDXPD)", div:1000, label:"Palladium"},
    {key:"Copper(USDXCU)",    div:1,    label:"Copper"}
  ];

  const setStatus = msg => document.getElementById("status").innerText = msg;

  // Load cache
  let hist = JSON.parse(localStorage.getItem("metalsHistFull") || "{}");

  // Build last 365 dates
  const needed=[];
  const today=new Date();
  for(let i=1;i<=365;i++){
    const d=new Date();
    d.setDate(today.getDate()-i);
    needed.push(d.toISOString().slice(0,10));
  }

  // Dates not in cache
  const missing = needed.filter(d => !hist[d]);

  // free approximate safe limit
  const MAX_CALLS = 20;
  const toFetch = missing.slice(0, MAX_CALLS);

  if(toFetch.length>0){
    setStatus(`Fetching ${toFetch.length} missing days…`);
  } else {
    setStatus("All data cached. Rendering chart.");
  }

  for(const date of toFetch){
    setStatus(`Fetching ${date}…`);

    // Correct historical endpoint
    const url = `https://metals-api.com/api/${date}?access_key=${KEY}`;
    try{
      const r=await fetch(url);
      const j=await r.json();

      if(j.success && j.rates){
        hist[date]={};
        METALS.forEach(m=>{
          hist[date][m.key] = j.rates[m.key] ?? null;
        });
      }
    }catch(e){
      console.error(e);
    }
  }

  // Save updated history
  localStorage.setItem("metalsHistFull", JSON.stringify(hist));

  // Build sorted date array
  const dates = Object.keys(hist).sort();

  // Build datasets
  const datasets = METALS.map(m=>{
    return {
      label: m.label,
      data: dates.map(d=>{
        const v = hist[d][m.key];
        return v ? v / m.div : null;
      }),
      tension: 0.2
    };
  });

  setStatus("Drawing chart…");

  new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels:dates, datasets},
    options:{
      interaction:{mode:"index",intersect:false},
      scales:{y:{title:{display:true,text:"Normalized"}}}
    }
  });

  setStatus("Done. Open daily to build full history.");

})();
</script>
</body></html>
