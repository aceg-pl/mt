<!doctype html><html><head>
<meta charset="utf-8"/>
<title>Metals Monthly Trends — Full Enhanced Version</title>

<style>
 body{
   font-family:-apple-system,system-ui;margin:0;padding:20px;
   background:#f4f4f4;
   transition:background .3s,color .3s;
 }
 #card{
   max-width:1000px;margin:auto;background:#fff;padding:16px;
   border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,.15);
   transition:background .3s,box-shadow .3s;
 }
 canvas{width:100%!important;height:480px!important;}
 #controls{display:flex;gap:10px;margin:10px 0;}
 button{
   padding:6px 12px;border-radius:6px;border:1px solid #aaa;
   background:#f0f0f0;cursor:pointer;font-size:14px;
   transition:background .2s;
 }
 button:hover{background:#e2e2e2;}
 small{color:#777;}
 .dark body{background:#111;color:#eee;}
 .dark #card{background:#222;box-shadow:0 4px 25px rgba(0,0,0,.4);}
 .dark button{background:#333;color:#eee;border-color:#555;}
 .dark button:hover{background:#444;}
</style>
</head><body>

<div id="card">
 <h3>Metals — Monthly Trend (Investing.com Enhanced)</h3>
 <small>Gold & Palladium ÷1000, Silver ÷10 — gradients, caching, export, dual-axes</small>

 <div id="controls">
   <button id="refresh">⟳ Refresh</button>
   <button id="smoothToggle">Smooth: ON</button>
   <button id="widgetBtn">Widget Mode</button>
   <button id="exportPNG">Export PNG</button>
   <button id="exportCSV">Export CSV</button>
 </div>

 <div id="status" style="margin-bottom:10px;color:#555"></div>
 <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(async()=>{

/* ---------------------------------
   CONFIG
----------------------------------*/

const setStatus = t => document.getElementById("status").innerText = t;

const SOURCES = {
  Gold:      "https://www.investing.com/currencies/xau-usd-historical-data?interval=Monthly",
  Silver:    "https://www.investing.com/currencies/xag-usd-historical-data?interval=Monthly",
  Palladium: "https://www.investing.com/currencies/xpd-usd-historical-data?interval=Monthly",
  Copper:    "https://www.investing.com/commodities/copper-historical-data?interval=Monthly"
};

// Metallic shades
const COLORS = {
  Gold:      "#d4af37",
  Silver:    "#c0c0c0",
  Palladium: "#b0b8c5",
  Copper:    "#b87333"
};

// Normalization
const NORMALIZE = { Gold:1000, Silver:10, Palladium:1000, Copper:1 };

const CACHE_KEY="metalsMonthlyCache_v2";

/* ---------------------------------
   DARK MODE AUTO
----------------------------------*/
if(window.matchMedia("(prefers-color-scheme: dark)").matches){
  document.body.classList.add("dark");
}

/* ---------------------------------
   HTML SCRAPER
----------------------------------*/

async function loadInvesting(url){
  const proxy="https://corsproxy.io/?";
  const html=await fetch(proxy+encodeURIComponent(url)).then(r=>r.text());
  const doc=new DOMParser().parseFromString(html,"text/html");

  const rows=[...doc.querySelectorAll("table tbody tr")];
  const out=[];

  for(const tr of rows){
    const tds=tr.querySelectorAll("td");
    if(tds.length<6) continue;

    const dateStr=tds[0].textContent.trim();
    const priceStr=tds[1].textContent.trim().replace(/,/g,"");
    const price=parseFloat(priceStr);
    const date=new Date(dateStr);

    if(isNaN(price)||isNaN(date)) continue;

    out.push({date:date.toISOString().slice(0,7),price});
  }
  return out.reverse();
}

/* ---------------------------------
   LOAD OR SCRAPE
----------------------------------*/
async function getData(force=false){
  let cache=localStorage.getItem(CACHE_KEY);
  if(cache && !force){
    return JSON.parse(cache);
  }

  setStatus("Scraping monthly data…");
  let raw={};

  for(const metal of Object.keys(SOURCES)){
    setStatus("Loading "+metal+"…");
    raw[metal]=await loadInvesting(SOURCES[metal]).catch(e=>[]);
  }

  localStorage.setItem(CACHE_KEY,JSON.stringify(raw));
  return raw;
}

/* ---------------------------------
   GRADIENT BUILDER
----------------------------------*/
function makeGradient(ctx,color){
  const g=ctx.createLinearGradient(0,0,0,300);
  g.addColorStop(0,color);
  g.addColorStop(1,color+"20");
  return g;
}

/* ---------------------------------
   EXPORT CSV
----------------------------------*/
function exportCSV(raw){
  let rows=["Date,Gold,Silver,Palladium,Copper"];
  const allDates=new Set();
  Object.values(raw).forEach(list=>list.forEach(r=>allDates.add(r.date)));
  const dates=[...allDates].sort();

  dates.forEach(d=>{
    const row=[d];
    for(const m of ["Gold","Silver","Palladium","Copper"]){
      const v=(raw[m].find(x=>x.date===d)||{}).price||"";
      row.push(v);
    }
    rows.push(row.join(","));
  });

  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="metals.csv";
  a.click();
}

/* ---------------------------------
   BUILD CHART
----------------------------------*/
let currentChart=null;

function buildChart(raw,smooth=true){
  setStatus("Rendering…");

  const ctx=document.getElementById("chart").getContext("2d");
  const allDates=new Set();
  Object.values(raw).forEach(list=>list.forEach(r=>allDates.add(r.date)));
  const dates=[...allDates].sort();

  // Metal datasets
  const dsNorm=Object.keys(raw).map(name=>{
    const map=new Map(raw[name].map(o=>[o.date,o.price]));
    return {
      label:name,
      borderColor:COLORS[name],
      backgroundColor:makeGradient(ctx,COLORS[name]),
      borderWidth:3,
      fill:true,
      yAxisID:"yNorm",
      data:dates.map(d=>map.has(d)?map.get(d)/NORMALIZE[name]:null),
      tension:smooth?0.35:0
    };
  });

  // USD dashed sets (right axis)
  const dsUSD=Object.keys(raw).map(name=>{
    const map=new Map(raw[name].map(o=>[o.date,o.price]));
    return {
      label:name+" (USD)",
      hidden:true,
      borderColor:COLORS[name],
      borderDash:[5,5],
      borderWidth:1.8,
      fill:false,
      yAxisID:"yUSD",
      data:dates.map(d=>map.get(d)||null),
      tension:smooth?0.35:0
    };
  });

  if(currentChart) currentChart.destroy();

  currentChart=new Chart(ctx,{
    type:"line",
    data:{labels:dates,datasets:[...dsNorm,...dsUSD]},
    options:{
      animation:{duration:800},
      interaction:{mode:"index",intersect:false},
      plugins:{
        tooltip:{
          callbacks:{
            label(ctx){
              const rawValue=ctx.raw;
              if(ctx.dataset.yAxisID==="yUSD") return ctx.dataset.label+": $"+rawValue;
              const metal=ctx.dataset.label;
              const date=ctx.label;
              const usd=(raw[metal].find(x=>x.date===date)||{}).price;
              return `${metal}: norm ${rawValue.toFixed(2)} — $${usd}`;
            }
          }
        },
        legend:{labels:{color:document.body.classList.contains("dark")?"#eee":"#333"}}
      },
      scales:{
        yNorm:{
          type:"linear",position:"left",
          grid:{color:document.body.classList.contains("dark")?"#555":"#ddd"},
          title:{display:true,text:"Normalized"}
        },
        yUSD:{
          type:"linear",position:"right",
          grid:{drawOnChartArea:false},
          title:{display:true,text:"USD Price"}
        },
        x:{
          grid:{
            color:document.body.classList.contains("dark")?"#333":"#eee",
            drawOnChartArea:true
          }
        }
      }
    }
  });

  setStatus("Ready.");
}

/* ---------------------------------
   WIDGET MODE
----------------------------------*/
function toggleWidget(){
  const card=document.getElementById("card");
  const canvas=document.getElementById("chart");

  if(card.style.maxWidth!=="250px"){
    card.style.maxWidth="250px";
    card.style.padding="8px";
    canvas.style.height="90px";
    document.body.style.padding="8px";
  } else {
    card.style.maxWidth="1000px";
    card.style.padding="16px";
    canvas.style.height="480px";
    document.body.style.padding="20px";
  }

  buildChart(currentData,smoothOn);
}

/* ---------------------------------
   INIT
----------------------------------*/
let currentData=null;
let smoothOn=true;

document.getElementById("smoothToggle").onclick=()=>{
  smoothOn=!smoothOn;
  document.getElementById("smoothToggle").innerText="Smooth: "+(smoothOn?"ON":"OFF");
  buildChart(currentData,smoothOn);
};

document.getElementById("widgetBtn").onclick=()=>toggleWidget();

document.getElementById("exportPNG").onclick=()=>{
  const url=currentChart.toBase64Image();
  const a=document.createElement("a");
  a.href=url;
  a.download="metals.png";
  a.click();
};

document.getElementById("exportCSV").onclick=()=>exportCSV(currentData);

document.getElementById("refresh").onclick=async()=>{
  setStatus("Forcing fresh scrape…");
  currentData=await getData(true);
  buildChart(currentData,smoothOn);
};

setStatus("Loading cache…");
currentData=await getData(false);
buildChart(currentData,smoothOn);

})();
</script>

</body></html>
