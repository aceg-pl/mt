<!doctype html><html><head>
<meta charset="utf-8"/>
<title>Metals 12-Month Auto Builder</title>
<style>
 body{font-family:-apple-system,system-ui;padding:20px;background:#fafafa}
 #card{max-width:960px;margin:auto;background:#fff;padding:16px;border-radius:8px;
       box-shadow:0 4px 14px rgba(0,0,0,.08)}
 canvas{width:100%!important;height:420px!important}
 small{color:#666}
</style>
</head><body>
<div id="card">
 <h3>Metals — Auto-Collected 12-Month Trend (Free Tier)</h3>
 <small>Gold & Palladium ÷1000, Silver ÷10 — Missing dates fetched gradually</small>
 <div id="status" style="margin-bottom:10px;color:#444"></div>
 <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async()=>{

  const KEY = "725119967737018ac36bec66d4a87c96";
  const METALS = [
    {code:"USDXAU", div:1000, label:"Gold"},
    {code:"USDXAG", div:10,   label:"Silver"},
    {code:"USDXPD", div:1000, label:"Palladium"},
    {code:"USDXCU", div:1,    label:"Copper"}
  ];

  const status = msg => document.getElementById("status").innerText = msg;

  // Load local history or empty
  let hist = JSON.parse(localStorage.getItem("metalsHistFull") || "{}");

  // Build list of last 365 days
  let needed = [];
  const today = new Date();
  for(let i=1;i<=365;i++){
    const d=new Date();
    d.setDate(today.getDate()-i);
    const s=d.toISOString().slice(0,10);
    needed.push(s);
  }

  // Determine which dates we still need
  const missing = needed.filter(d => !hist[d]);

  // Free plan safe limit: ~20 calls per load
  const MAX_CALLS = 20;
  const toFetch = missing.slice(0, MAX_CALLS);

  if(toFetch.length>0){
    status(`Fetching ${toFetch.length} missing days…`);
  } else {
    status("All data cached — full history built!");
  }

  // Fetch each missing date (up to limit)
  for(const date of toFetch){
    status(`Fetching ${date}…`);

    const url = `https://metals-api.com/api/${date}?access_key=${KEY}`;
    try{
      const r = await fetch(url);
      const j = await r.json();

      if(j.success && j.rates){
        hist[date]={};
        METALS.forEach(m=>{
          hist[date][m.code] = j.rates[m.code] || null;
        });
      }

    }catch(e){
      console.error(e);
    }
  }

  // Save updated history
  localStorage.setItem("metalsHistFull", JSON.stringify(hist));

  status("Rendering chart…");

  // Build sorted date list
  const dates = Object.keys(hist).sort();

  // Build datasets
  const datasets = METALS.map(m=>{
    return {
      label:m.label,
      data:dates.map(d=>{
        const v = hist[d][m.code];
        return v ? v/m.div : null;
      }),
      tension:.2
    };
  });

  // Draw chart
  new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels:dates, datasets},
    options:{
      interaction:{mode:"index",intersect:false},
      scales:{y:{title:{display:true,text:"Normalized"}}}
    }
  });

  status("Done — chart updated. Open this page daily to build full history.");

})();
</script>
</body></html>
